# 产品成本和模具费用计算指南

> 本指南详细说明了模具和产品成本的计算方法，以及如何优化穴数布局以达到最低总成本。

当我们为客户生产产品时，总价由两大部分组成：

1. 模具费用：制作模具本身的费用
2. 产品费用：使用该模具批量生产客户所需产品的费用

我们需要根据客户要求的产品数量 (Q) 来选择合适的"穴数" (c)，从而达到总费用的最优（最低）状态。

---

## 一、模具费用的计算

### 1. 模具成本 {#mold-cost}
模具体积(V)取决于模具的宽度、高度和深度（即模具尺寸会随着穴数和产品类型/组合而变化）。
模具材料的密度和单位价格为固定常数。

公式：\
模具材料成本 = 模具体积 × 模具材料密度 × 模具材料单价

### 2. 额外加工费 {#processing-cost}
在制作模具时的特殊加工成本，可能由材料或复杂工序决定。

### 3. 模具利润 {#mold-profit}
为了盈利，在成本基础上加上利润（利润比例为已知常数 r_m）。
若吨位超过一定门槛，利润系数可能不同。

公式：\
模具售价 = (模具材料成本 + 额外加工费) × (1 + 利润系数)

---

## 二、产品费用的计算 {#product-cost}

### 1. 产品材料成本 {#material-cost}
每件产品有自己的净体积、材料密度和材料单价。\
单件产品成本 = 产品净体积 × 产品材料密度 × 产品材料单价\
总产品材料成本 = ∑(Q_i × 单件产品成本_i)\
(对多产品场景，将每种产品的成本求和)

### 2. 材料损耗 {#material-waste}
生产中有损耗，损耗系数为常数。\
总损耗费用 = 总产品材料成本 × 损耗系数

### 3. 加工费用 {#processing-fee}
模具大小和总注胶量决定所需机器吨位。机器吨位越大，成本越高。\
若有多种产品同时出模，注胶总量为各产品单件体积 × 密度 × 各自穴数之和。

### 4. 生产模次 {#production-shots}
对单产品：模次 = 向上取整(Q / 穴数)

对多产品且颜色相同的情况：\
可以同时出模生产多种产品，模次由需求最高的产品决定（或根据实际策略计算）。

对多产品且颜色不同的情况：\
需要分阶段生产。例如，先生产A（暂时封住B的腔不注胶或不使用），当A达成数量后，再生产B（不使用A的腔）。\
这样总模次 = A所需模次 + B所需模次。

不同颜色会影响生产策略：
* 若颜色相同：可一次性同时生产A和B，减少总模次。
* 若颜色不同：需先生产完一种颜色的产品，再生产另一种。

### 5. 产品利润 {#product-profit}
在产品生产总成本（材料+损耗+加工）上加利润。\
产品总售价 = (总产品材料成本 + 总损耗费用 + 总加工成本) × (1 + 产品利润系数)

---

## 三、模具尺寸的计算 {#mold-dimensions}

### 1. 布局优化 {#layout-optimization}
对于给定的产品组合和穴数方案，需要进行型腔布局优化：
- 基于产品包络体积的二维投影（宽W和深D）进行布局计算
- 考虑产品间的最小间距要求
- 通过最小面积布局算法（Minimum Area Layout）获得最优布局方案
- 计算最小外接矩形面积（Minimum Bounding Rectangle）

### 2. 模具尺寸确定 {#size-determination}
- 在最优布局基础上，结合产品高度(H)计算基础体积
- 添加边缘安全裕度（考虑模具结构要求）
- 添加垂直方向的高度裕度
- 计算最终模具体积 = (最小布局宽度 + 边缘裕度) × (最小布局深度 + 边缘裕度) × (最大产品高度 + 高度裕度)

### 3. 布局合理性评分 {#layout-scoring}
对计算得到的布局方案进行综合评分，评估其合理性：

1. **几何平衡评分** {#geometric-balance}
   - 评估产品在三维空间中的几何分布
   - 考虑产品的形状、尺寸和相对位置关系
   - 确保产品布局在几何上的合理性

2. **分布平衡评分** {#distribution-balance}
   - 评估产品在模具中的空间分布
   - 考虑重心分布和力的平衡
   - 确保模具开合时的稳定性

3. **流动平衡评分** {#flow-balance}
   - 评估材料在模具中的流动路径
   - 考虑浇口位置和流道设计
   - 确保材料填充的均匀性

综合评分计算：
- 总分 = w1×几何平衡分 + w2×分布平衡分 + w3×流动平衡分
- 设定最低分阈值
- 低于阈值的布局方案将被视为不可行方案

> **注意**：布局评分算法已实现，可直接通过三维几何坐标布局获得综合评分。

这些计算将直接影响模具的材料成本和所需的机器吨位。

---

## 四、总费用 {#total-cost}

最终价格：\
总费用 = 模具售价 + 产品总售价

---

## 五、寻找最优穴数 {#cavity-optimization}

1. 穴数取值范围
   - 每种产品的穴数都有其合理范围，由以下因素决定：
     * 产品尺寸：影响单穴占用空间
     * 模具最大尺寸：限制总空间
     * 机器吨位：限制最大注射量

2. 优化策略
   - 对每个可能的穴数组合 (c_1, c_2, ..., c_n)：
     * 计算模具成本：通过布局算法得到最小模具体积
     * 计算产品成本：考虑材料、损耗、加工费用等
     * 计算总成本
   - 从所有可行方案中选择总成本最低的方案

3. 搜索方法
   - 当可能的组合数较少时（如 ≤ 1000）：
     * 直接枚举所有穴数组合
     * 并行计算以提高效率
   - 当组合数过多时：
     * 使用启发式搜索
     * 应用比例约束（如c_i / c_j应在合理范围内）
     * 优先搜索经验值附近的解

---

## 计划中的代码结构 {#code-structure}

```
src/
└── lib/
    └── quote-price/
        ├── index.ts                  # quote-price模块的入口文件
        ├── materials/                # 材料管理（顶层模块）
        │   ├── index.ts              # 材料模块入口
        │   ├── mold-materials.ts     # 模具材料定义和查询
        │   ├── product-materials.ts  # 产品材料定义和查询
        │   └── types.ts              # 材料相关类型定义
        ├── mold/
        │   ├── index.ts              # 汇总模具相关函数的入口
        │   ├── cost.ts               # 计算模具成本的逻辑
        │   ├── layout/               # 模具布局相关逻辑
        │   │   ├── index.ts          # 布局模块入口
        │   │   ├── min-area.ts       # 最小面积布局算法
        │   │   ├── cavity-spacing.ts # 型腔间距计算
        │   │   ├── safety-margin.ts  # 安全裕度计算
        │   │   └── balance/          # 布局平衡评分
        │   │       ├── index.ts      # 评分模块入口
        │   │       ├── geometric.ts  # 几何平衡评分
        │   │       ├── distribution.ts # 分布平衡评分
        │   │       └── flow.ts       # 流动平衡评分
        │   ├── dimensions.ts         # 模具最终尺寸计算
        │   └── profit.ts             # 模具利润计算
        ├── product/
        │   ├── index.ts              # 产品模块入口
        │   ├── types.ts              # 产品相关类型定义（含颜色信息）
        │   ├── cost.ts               # 产品成本计算
        │   ├── volume.ts             # 产品体积计算（净体积和包络体积）
        │   ├── waste.ts              # 损耗计算
        │   └── production-strategy.ts # 多产品组合生产策略
        ├── machine/
        │   ├── index.ts              # 机器相关函数入口
        │   ├── tonnage.ts            # 机器吨位计算
        │   └── operation-cost.ts     # 加工费用计算
        └── optimization/
            ├── index.ts              # 优化模块入口
            └── cavity-search/        # 穴数优化
                ├── index.ts          # 穴数搜索入口
                ├── constraints.ts    # 穴数约束条件
                ├── cost-function.ts  # 成本计算函数
                └── search-strategy.ts # 搜索策略实现